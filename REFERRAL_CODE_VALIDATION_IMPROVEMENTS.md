# –£–ª—É—á—à–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Referral –∫–æ–¥–æ–≤

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ö–ª–∏–µ–Ω—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π referral –∫–æ–¥ –≤ —Å–≤–æ–µ–º –±—É–∫–∏–Ω–≥–µ –∏ –ø–æ–ª—É—á–∏–ª–∞ $10, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º —Å–∏—Å—Ç–µ–º–æ–π.

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –≤—ã–¥–∞—á–µ–π –Ω–∞–≥—Ä–∞–¥—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ `isSelfReferral` - Customer ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Referrer ID
- ‚úÖ `isOwnCode` - Customer –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π `personal_code`
- ‚úÖ `isKnownReferrer` - Customer —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ referrer

**–õ–æ–≥–∏–∫–∞:**
```javascript
if (isSelfReferral || isOwnCode || isKnownReferrer) {
  // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–µ –≤—ã–¥–∞–≤–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É
  // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å referral code –≤ used_referral_code
  // –ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
}
```

### 2. –†–∞–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (Early Validation)

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–î–û** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `used_referral_code` –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π `personal_code`, –∫–æ–¥ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å—Ä–∞–∑—É
- –≠–∫–æ–Ω–æ–º–∏—Ç —Ä–µ—Å—É—Ä—Å—ã –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### 3. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- üìã Customer ID, name, personal_code
- üìã Referrer ID, name, personal_code
- üìç –ò—Å—Ç–æ—á–Ω–∏–∫ referral code (–≥–¥–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω)
- üîí –î–µ—Ç–∞–ª–∏ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚ùå –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**
```
üéÅ Customer used referral code: BOZHENA8884
   üìã Customer ID: CUSTOMER_123
   üìã Customer name: Jane Doe
   üìã Customer personal_code: JANE1234
   üìç Code source: customer.custom_attributes[square:xxx-xxx-xxx]
üë§ Found referrer: Bozhena Smith
   üìã Referrer ID: REFERRER_456
   üìã Referrer personal_code: BOZHENA8884
   üîí Validation checks:
      - Is self-referral (same customer ID): false
      - Is own code (personal_code matches): false
      - Is known referrer: false
   ‚úÖ Validation passed - referral code is valid
```

### 4. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ referral code –∏–∑ Square webhooks

**–ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞:**
1. `serviceVariationCapabilityDetails` - extension data
2. `booking.custom_fields` - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –±—É–∫–∏–Ω–≥–∞
3. `appointment_segments.custom_fields` - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
4. `customer.custom_attributes['referral_code']` - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª—é—á
5. `customer.custom_attributes[*]` - –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è Square-generated keys)

**–í–∞–∂–Ω–æ:** –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –í–°–ï –∑–Ω–∞—á–µ–Ω–∏—è –≤ custom attributes, –≤–∫–ª—é—á–∞—è –∫–ª—é—á–∏ –≤–∏–¥–∞ `square:xxx-xxx-xxx`, –ø–æ—Ç–æ–º—É —á—Ç–æ Square –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å referral code –ø–æ–¥ –ª—é–±—ã–º –∫–ª—é—á–æ–º.

### 5. –ó–∞–ø–∏—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

–ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –≤ `ReferralEvent`:
```javascript
{
  eventType: 'CUSTOM',
  metadata: {
    referralCode,
    blocked: true,
    reason: 'customer_used_own_personal_code' | 'self_referral' | 'known_referrer',
    bookingId,
    customerPersonalCode
  }
}
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è.

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook

–í Vercel logs –∏—â–∏—Ç–µ:
- `üéÅ Customer used referral code:` - –∫–æ–≥–¥–∞ –∫–æ–¥ –Ω–∞–π–¥–µ–Ω
- `‚ùå BLOCKED:` - –∫–æ–≥–¥–∞ –∫–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- `‚úÖ Validation passed` - –∫–æ–≥–¥–∞ –∫–æ–¥ –≤–∞–ª–∏–¥–µ–Ω

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
SELECT * FROM referral_events 
WHERE metadata->>'blocked' = 'true'
ORDER BY created_at DESC;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã
SELECT square_customer_id, personal_code, used_referral_code 
FROM square_existing_clients 
WHERE used_referral_code IS NOT NULL;
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è

```bash
node scripts/test-referral-code-extraction.js
```

## üìä –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —á—É–∂–æ–π referral –∫–æ–¥
2. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç referrer –≤ –±–∞–∑–µ
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —ç—Ç–æ –Ω–µ self-referral
4. –í—ã–¥–∞–µ—Ç $10 gift card –∫–ª–∏–µ–Ω—Ç—É
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `used_referral_code`

### ‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. –ö–ª–∏–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–¥
2. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç, —á—Ç–æ `customer.personal_code === referralCode`
3. **–ë–ª–æ–∫–∏—Ä—É–µ—Ç** –≤—ã–¥–∞—á—É –Ω–∞–≥—Ä–∞–¥—ã
4. **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç** `used_referral_code`
5. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

## üöÄ –î–µ–ø–ª–æ–π

–ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã –≤ production:
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –†–∞–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- ‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

## üìù –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:
1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
2. –õ–æ–≥–∏ webhook –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è referral –∫–æ–¥–æ–≤



