# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞–º

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–°–∏—Å—Ç–µ–º–∞ –Ω–µ –≤—ã–¥–∞–≤–∞–ª–∞ –Ω–∞–≥—Ä–∞–¥—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–∞–º –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –∏—Ö –¥—Ä—É–∑–µ–π (–Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Ö –∏—Ö –∫–æ–¥—ã). –ü—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–ª–∞ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ:

1. **–°–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞ ~15 –¥–Ω–µ–π** - –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å
2. **–ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è** –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤—Å–µ –∑–∞—Å—Ç—Ä—è–≤—à–∏–µ —Ä–∞–±–æ—Ç—ã, –Ω–æ –ª–æ–≥–∏–∫–∞ –∏–º–µ–ª–∞ –±–∞–≥:
   - –ï—Å–ª–∏ `first_payment_completed = TRUE`, —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞—Å—å —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
   - –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞, –±—ã–ª–∞ –ª–∏ —É–∂–µ –≤—ã–¥–∞–Ω–∞ –Ω–∞–≥—Ä–∞–¥–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä—É
   - –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –ø—Ä–æ–ø—É—Å–∫—É –Ω–∞–≥—Ä–∞–¥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ñ–ª–∞–≥ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –Ω–∞–≥—Ä–∞–¥–∞ –Ω–µ –±—ã–ª–∞ –≤—ã–¥–∞–Ω–∞

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ `processPaymentCompletion`

**–§–∞–π–ª:** `lib/webhooks/giftcard-processors.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –í–º–µ—Å—Ç–æ —Ä–∞–Ω–Ω–µ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–∏ `first_payment_completed = TRUE`, —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –±—ã–ª–∞ –ª–∏ —É–∂–µ –≤—ã–¥–∞–Ω–∞ –Ω–∞–≥—Ä–∞–¥–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä—É–∑–µ–π, –∑–∞–≤–µ—Ä—à–∏–≤—à–∏—Ö –ø–ª–∞—Ç–µ–∂, —Å `total_referrals` —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
- –ï—Å–ª–∏ –Ω–∞–≥—Ä–∞–¥–∞ –Ω–µ –±—ã–ª–∞ –≤—ã–¥–∞–Ω–∞, –æ–Ω–∞ –≤—ã–¥–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–ª–∞–≥ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–õ–æ–≥–∏–∫–∞:**
```javascript
// –°—á–∏—Ç–∞–µ–º –¥—Ä—É–∑–µ–π, –∑–∞–≤–µ—Ä—à–∏–≤—à–∏—Ö –ø–ª–∞—Ç–µ–∂
const friendsCompleted = COUNT(friends WHERE first_payment_completed = TRUE)

// –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
const actualReferrals = referrer.total_referrals

// –ï—Å–ª–∏ friendsCompleted > actualReferrals, –Ω–∞–≥—Ä–∞–¥–∞ –Ω–µ –±—ã–ª–∞ –≤—ã–¥–∞–Ω–∞
if (friendsCompleted > actualReferrals) {
  // –í—ã–¥–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É
}
```

### 2. –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### `scripts/find-missing-referrer-rewards.js`
- –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂, –Ω–æ –∏—Ö —Ä–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –ø–æ–ª—É—á–∏–ª –Ω–∞–≥—Ä–∞–¥—É
- –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–∞–º–æ–ø–µ—Ä–µ—Ö–æ–¥—ã (self-referrals)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Å–ª—É—á–∞—é

#### `scripts/issue-missing-referrer-rewards.js`
- –í—ã–¥–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–∞–º
- –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –ø–æ–¥–∞—Ä–æ—á–Ω—É—é –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ —É —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –µ—ë –Ω–µ—Ç
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç $10 –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º `--dry-run` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### `scripts/check-specific-referral-cases.js`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏, —É–ø–æ–º—è–Ω—É—Ç—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∫–∞—Ä—Ç —á–µ—Ä–µ–∑ Square API
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞–∂–¥–æ–º—É —Å–ª—É—á–∞—é

## üìã –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å–ª—É—á–∞–∏:

1. **Marina Apostolaki ‚Üí Anna-Maria Burachek (ANNAMARIA1737)**
   - ‚úÖ Friend completed payment: –î–∞
   - ‚úÖ Referrer stats: 1 referral, $10.00 rewards
   - ‚úÖ Referrer has gift card: –î–∞
   - ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã

2. **Rahel Tekeste ‚Üí Makda Tgeb (MAKDA4078)**
   - ‚úÖ Friend completed payment: –î–∞
   - ‚úÖ Referrer stats: 1 referral, $10.00 rewards
   - ‚úÖ Referrer has gift card: –î–∞
   - ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã

3. **Mariele Longfellow ‚Üí Brenna Stanton (BRENNA1414)**
   - ‚úÖ Friend completed payment: –î–∞
   - ‚úÖ Referrer stats: 1 referral, $10.00 rewards
   - ‚úÖ Referrer has gift card: –î–∞
   - ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã

4. **Kate Rodgers ‚Üí Kate Van Van Horne (KATE1520)**
   - ‚úÖ Friend completed payment: –î–∞
   - ‚úÖ Referrer stats: 1 referral, $10.00 rewards
   - ‚úÖ Referrer has gift card: –î–∞
   - ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã

5. **Laura Craciun ‚Üí Kathleen Kelly (KATHLEEN9248)**
   - ‚ùå Friend completed payment: –ù–µ—Ç (–ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω)
   - ‚ÑπÔ∏è –ù–∞–≥—Ä–∞–¥–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–¥–∞–Ω–∞ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

## üîß –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã

### 1. –ù–∞–π—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã:
```bash
node scripts/find-missing-referrer-rewards.js
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏:
```bash
node scripts/check-specific-referral-cases.js
```

### 3. –í—ã–¥–∞—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã (dry-run):
```bash
node scripts/issue-missing-referrer-rewards.js --dry-run
```

### 4. –í—ã–¥–∞—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã (—Ä–µ–∞–ª—å–Ω–æ):
```bash
node scripts/issue-missing-referrer-rewards.js
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∫–∞—Ä—Ç**: –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Square API –∫–ª—é—á–µ–π
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤–æ–π –≤—ã–¥–∞—á–µ–π
3. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏**: –ù–∞–≥—Ä–∞–¥—ã –º–æ–≥–ª–∏ –±—ã—Ç—å –≤—ã–¥–∞–Ω—ã –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–¥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞). –°–∫—Ä–∏–ø—Ç—ã –ø–æ–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∞–∫–∏–µ —Å–ª—É—á–∞–∏

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- –í—Å–µ–≥–æ –¥—Ä—É–∑–µ–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Ö –∫–æ–¥—ã: 10
- –î—Ä—É–∑–µ–π, –∑–∞–≤–µ—Ä—à–∏–≤—à–∏—Ö –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂: 8
- –†–µ—Ñ–µ—Ä–µ—Ä–æ–≤, –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö: 10
- –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥ (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–∞–º–æ–ø–µ—Ä–µ—Ö–æ–¥–æ–≤): 0

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –Ω–∞–≥—Ä–∞–¥ –±—ã–ª–∏ –≤—ã–¥–∞–Ω—ã, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –∫–∞—Ä—Ç.

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
2. ‚úÖ –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
3. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∫–∞—Ä—Ç —á–µ—Ä–µ–∑ Square API
4. ‚è≥ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã–¥–∞—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã
5. ‚è≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `giftcard-processors.js`:
- `createPromotionOrder` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ-–∑–∞–∫–∞–∑–∞
- `completePromotionOrderPayment` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ –ø—Ä–æ–º–æ-–∑–∞–∫–∞–∑—É
- `findReferrerByCode` - –ø–æ–∏—Å–∫ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –ø–æ –∫–æ–¥—É

–≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö.



